/*
 0BSD
*/
(function(){function r(f){var e=new Uint8Array(2);(new DataView(e.buffer)).setUint16(0,f,!1);return e}function t(f){var e=f[0];var a=f.subarray(1,3);a=(new DataView(a.buffer,a.byteOffset,a.byteLength)).getUint16(0,!1);return[e,f.slice(3,3+a)]}function n(f,e,a){f=new Uint8Array(f);f.set(e);f.set(a,2);return f}function u(f,e,a){a=new Uint8Array(3+a);a.set([f]);a.set(r(e.length),1);a.set(e,3);return a}function h(f,e){return f.join(",")+e.join(",")}function m(f){if(f instanceof Error)return console.error(f)}
function p(f){function e(a,b,c,d){null==d&&(d=10);if(!(this instanceof e))return new e(a,b,c,d);f.call(this);this.l=a;this.v=b;this.u=c;this.N=d;this.b=new Map;this.g=new Set;this.f=new Map;this.m=new Map;this.o=new Map;this.a=new Map}e.prototype={X:function(a,b){if(b.length===this.l){var c=[b.subarray(0,2),b.subarray(2)];b=c[0];c=c[1];this.c("activity",a,b);var d=h(a,b);this.b.has(d)||this.g.has(d)||this.a.has(d)?this.O(a,b,c):this.P(a,b,c)}},U:function(a,b){this.b.set(h(a,b),[a]);this.h(a,b)},T:function(a,
b){this.g.add(h(a,b));this.h(a,b)},S:function(a,b){a=h(a,b);b=this.o.get(a);this.b.get(a).push(b);this.o["delete"](a)},H:function(a,b){if(b.length>this.i())throw new RangeError("Too much command data");var c=this.M(a);b=this.D(c,v,b);this.j(a,c,b);this.s(a,c);return c},V:function(a,b,c){if(c.length>this.i())throw new RangeError("Too much command data");c=this.D(b,w,c);this.j(a,b,c)},W:function(a,b,c,d){var g,e=this;var k=h(a,b);if(!this.b.has(k))throw new ReferenceError("There is no such segment established");
if(d.length>this.i()-this.v)throw new RangeError("Too much command data");var l=this.b.get(k).slice(-1)[0];var f=g=new Uint8Array(c.length+d.length);f.set(c);f.set(d,c.length);this.A(a,b,l,x,g).then(function(d){e.j(a,b,d);e.o.set(k,c)})["catch"](m)},C:function(a,b,c){var d=this;this.A(a,b,a,y,c).then(function(c){d.j(a,b,c)})["catch"](m)},I:function(a,b){var c=h(a,b);this.b["delete"](c);this.g["delete"](c);this.o["delete"](c);this.h(a,b);if(this.a.has(c)){var d=this.a.get(c);c=d[0];d=d[1];this.B(a,
b);this.I(c,d)}else this.B(a,b)},data:function(a,b,c,d,g){var e=this;var k=h(a,b);if(!this.b.has(k)&&!this.g.has(k))throw new ReferenceError("There is no such segment established");if(g.length>this.i())throw new RangeError("Too much command data");this.A(a,b,c,d+q,g).then(function(c){e.j(a,b,c)})["catch"](m)},i:function(){return this.l-2-1-2-this.u},j:function(a,b,c){this.c("activity",a,b);return this.c("send",a,c)},P:function(a,b,c){var d=h(a,b);c=t(c);var g=c[0];c=c[1];switch(g){case v:this.s(a,
b);this.c("create_request",a,b,c);break;case w:this.f.has(d)&&(d=this.f.get(d),(d=d.Z)?(a=d[0],b=d[1],this.C(a,b,c)):this.c("create_response",a,b,c))}},O:function(a,b,c){var d=this;this.R(a,b,c).then(function(c){var e=h(a,b);!d.g.has(e)&&d.a.has(e)?d.w(e,c):d.K(a,b,c).then(function(c){var g=t(c.plaintext);var f=g[0];g=g[1];switch(f){case x:try{var k=g.subarray(0,d.v);var z=g.subarray(d.v);var h=d.H(k,z);var m=[a,b];var A=[k,h];d.s(a,b,{Y:A});d.s(k,h,{Z:m})}catch(B){c=B;if(!(c instanceof RangeError))throw c;
d.C(a,b,new Uint8Array(0))}break;case y:d.o.has(e)&&d.c("extend_response",a,b,g);break;default:f<q||d.c("data",a,b,c.target_address,f-q,g)}},function(){var g;if(d.a.has(e))d.w(e,c);else if(d.f.has(e)){var f=d.f.get(e);if(g=f.Y)f=g[0],g=g[1],d.h(a,b),d.h(f,g),d.J(a,b,f,g)&&d.w(e,c)}})})["catch"](m)},w:function(a,b){var c=this.a.get(a);a=c[0];c=c[1];b=n(this.l,c,b);this.j(a,c,b)},M:function(a){var b;var c=0;for(b=Math.pow(2,16);c<b;++c){var d=c;d=r(d);var g=h(a,d);if(!(this.b.has(g)||this.f.has(g)||
this.g.has(g)||this.a.has(g)))return d}throw new RangeError("Out of possible segment IDs");},D:function(a,b,c){b=u(b,c,this.i());return n(this.l,a,b)},A:function(a,b,c,d,g){var e=this;d=u(d,g,this.i());return this.L(a,b,c,d).then(function(a){return n(e.l,b,a)})},J:function(a,b,c,d){var e=h(a,b);var f=h(c,d);if(this.a.has(e)||this.a.has(f))return!1;this.a.set(e,[c,d]);this.a.set(f,[a,b]);return!0},B:function(a,b){a=h(a,b);if(this.a.has(a)){var c=this.a.get(a);b=c[0];c=c[1];b=h(b,c);this.a["delete"](a);
this.a["delete"](b)}},s:function(a,b,c){null==c&&(c={});this.h(a,b);var d=h(a,b);var e=a.join("");this.f.set(d,c);this.m.has(e)||this.m.set(e,[]);c=this.m.get(e);c.push(b);c.length>this.N&&(b=c.shift(),this.h(a,b))},h:function(a,b){var c;var d=h(a,b);if(this.f.has(d)){this.f["delete"](d);a=a.join("");b=b.join("");d=this.m.get(a);var e=0;for(c=d.length;e<c;++e){var f=e;var k=d[e];if(k.join("")===b){d.splice(f,1);return}}if(!d.length)this.m["delete"](a)}},L:function(a,b,c,d){var e,f=this;var k=h(a,
b);var l={address:a,segment_id:b,target_address:c,plaintext:d,ciphertext:null};var m=this.c("encrypt",l).then(function(){var a=l.ciphertext;if(!(a instanceof Uint8Array)||a.length!==d.length+f.u)throw"Encryption failed";return a});this.b.has(k)?e=this.b.get(k):e=[c];e=function(a){var b,c;var d=[];var f=0;for(c=(b=e).length;f<c;++f){var g=b[f];d.push(g);if(a===g.join(","))break}return d}.call(this,c.join(","));e.reverse().forEach(function(c){return m=m.then(function(d){return f.G(a,b,c,d)})});return m},
K:function(a,b,c){var d,e=this;var f=h(a,b);this.b.has(f)?d=this.b.get(f):d=[a];var k=Promise.reject();var l={address:a,segment_id:b,target_address:null,ciphertext:c,plaintext:null};d.forEach(function(d,f){k=k["catch"](function(){l.target_address=d;return 0<f?e.F(a,b,d,l.ciphertext).then(function(a){l.ciphertext=a;return e.c("decrypt",l)}):e.c("decrypt",l)}).then(function(){var a=l.plaintext;if(!(a instanceof Uint8Array)||a.length!==c.length-e.u)throw"Decryption failed";return l})});return k},R:function(a,
b,c){var d=h(a,b);if(this.b.has(d)||this.g.has(d))return this.F(a,b,a,c);a=this.a.get(d);b=a[0];return this.G(b,a[1],b,c)},G:function(a,b,c,d){var e={address:a,segment_id:b,target_address:c,unwrapped:d,wrapped:null};return this.c("wrap",e).then(function(){var a=e.wrapped;if(!(a instanceof Uint8Array)||a.length!==d.length)throw"Wrapping failed";return a})},F:function(a,b,c,d){var e={address:a,segment_id:b,target_address:c,wrapped:d,unwrapped:null};return this.c("unwrap",e).then(function(){var a=e.unwrapped;
if(!(a instanceof Uint8Array)||a.length!==d.length)throw"Unwrapping failed";return a})}};e.prototype=Object.assign(Object.create(f.prototype),e.prototype);e.prototype.c=e.prototype.fire;e.prototype.process_packet=e.prototype.X;e.prototype.confirm_outgoing_segment_established=e.prototype.U;e.prototype.confirm_incoming_segment_established=e.prototype.T;e.prototype.confirm_extended_path=e.prototype.S;e.prototype.create_request=e.prototype.H;e.prototype.create_response=e.prototype.V;e.prototype.extend_request=
e.prototype.W;e.prototype.destroy=e.prototype.I;e.prototype.data=e.prototype.data;e.prototype.get_max_command_data_length=e.prototype.i;Object.defineProperty(e.prototype,"constructor",{value:e});return e}var v=0;var w=1;var x=2;var y=3;var q=10;"function"===typeof define&&define.amd?define(["async-eventer"],p):"object"===typeof exports?module.exports=p(require("async-eventer")):this.ronion=p(this.async_eventer)}).call(this);