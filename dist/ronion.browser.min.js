/*
 Copyright (c) 2017, Nazar Mokrynskyi
 @license   MIT License, see license.txt
*/
(function(t){if("object"===typeof exports&&"undefined"!==typeof module)module.exports=t();else if("function"===typeof define&&define.a)define([],t);else{var f;"undefined"!==typeof window?f=window:"undefined"!==typeof global?f=global:"undefined"!==typeof self?f=self:f=this;f.W=t()}})(function(){return function q(f,m,n){function h(e,k){if(!m[e]){if(!f[e]){var p="function"==typeof require&&require;if(!k&&p)return p(e,!0);if(l)return l(e,!0);k=Error("Cannot find module '"+e+"'");throw k.code="MODULE_NOT_FOUND",
k;}k=m[e]={exports:{}};f[e][0].call(k.exports,function(a){var b=f[e][1][a];return h(b?b:a)},k,k.exports,q,f,m,n)}return m[e].exports}for(var l="function"==typeof require&&require,e=0;e<n.length;e++)h(n[e]);return h}({1:[function(f,m,n){(function(){function f(){if(!(this instanceof f))return new f;this.A={}}f.prototype={on:function(h,f){var e;h&&f&&((e=this.A)[h]||(e[h]=[])).push(f);return this},off:function(h,f){(h=this.A[h])&&h.splice(h.indexOf(f),f?1:h.length);return this},once:function(f,l){var e=
this;if(f&&l){var h=function(){if(!h.a)return h.a=!0,e.off(f,h),l.apply(null,arguments)};this.on(f,h)}return this},fire:function(f,l){var e=Promise.resolve();var h=arguments;(this.A[f]||[]).forEach(function(f){e=e.then(function(){var e=f.call.apply(f,h);return!1===e?Promise.reject():e})});e["catch"](function(e){e instanceof Error&&console.error(e)});return e}};"object"===typeof n?m.exports=f:this.async_eventer=f}).call(this)},{}],2:[function(f,m){(function(){function n(a){var b=a%256;return Uint8Array.of((a-
b)/256,b)}function q(a){var b=a.subarray(1,3);return[a[0],a.slice(3,3+(256*b[0]+b[1]))]}function h(a,b,c,d){a=new Uint8Array(a);a.set([b]);a.set(c,1);a.set(d,3);return a}function l(a,b,c){c=new Uint8Array(3+c);c.set([a]);c.set(n(b.length),1);c.set(b,3);return c}function e(a,b){return a.join(",")+b.join(",")}function p(a){if(a instanceof Error)return console.error(a)}function k(a,b,c,d,g){null==g&&(g=10);if(!(this instanceof k))return new k(a,b,c,d,g);u.call(this);this.s=a;this.i=b;this.w=c;this.v=
d;this.O=g;this.b=new Map;this.f=new Set;this.c=new Map;this.j=new Map;this.l=new Map;this.a=new Map}var u=f("async-eventer");m.exports=k;k.prototype={process_packet:function(a,b){if(b.length===this.i){var c=[b[0],b.subarray(1,3),b.subarray(3)];var d=c[0];b=c[1];c=c[2];d===this.s&&(this.fire("activity",a,b),d=e(a,b),this.b.has(d)||this.f.has(d)||this.a.has(d)?this.P(a,b,c):this.R(a,b,c))}},confirm_outgoing_segment_established:function(a,b){this.b.set(e(a,b),[a]);this.g(a,b)},confirm_incoming_segment_established:function(a,
b){this.f.add(e(a,b));this.g(a,b)},confirm_extended_path:function(a,b){a=e(a,b);b=this.l.get(a);this.b.get(a).push(b);this.l["delete"](a)},create_request:function(a,b){if(b.length>this.m())throw new RangeError("Too much command data");var c=this.N(a);b=this.F(c,0,b);this.h(a,c,b);this.o(a,c);return c},create_response:function(a,b,c){if(c.length>this.m())throw new RangeError("Too much command data");c=this.F(b,1,c);this.h(a,b,c)},extend_request:function(a,b,c,d){var g,r=this;var f=e(a,b);if(!this.b.has(f))throw new ReferenceError("There is no such segment established");
if(d.length>this.m()-this.w)throw new RangeError("Too much command data");var w=this.b.get(f).slice(-1)[0];var h=g=new Uint8Array(c.length+d.length);h.set(c);h.set(d,c.length);this.u(a,b,w,2,g).then(function(d){r.h(a,b,d);r.l.set(f,c)})["catch"](p)},D:function(a,b,c){var d=this;this.u(a,b,a,3,c).then(function(c){d.h(a,b,c)})["catch"](p)},destroy:function(a,b){var c=e(a,b);this.b["delete"](c);this.f["delete"](c);this.l["delete"](c);this.g(a,b);if(this.a.has(c)){var d=this.a.get(c);c=d[0];d=d[1];this.C(a,
b);this.destroy(c,d)}else this.C(a,b)},data:function(a,b,c,d,g){var f=this;var h=e(a,b);if(!this.b.has(h)&&!this.f.has(h))throw new ReferenceError("There is no such segment established");if(g.length>this.m())throw new RangeError("Too much command data");this.u(a,b,c,d+10,g).then(function(c){f.h(a,b,c)})["catch"](p)},get_max_command_data_length:function(){return this.i-1-2-1-2-this.v},h:function(a,b,c){this.fire("activity",a,b);return this.fire("send",a,c)},R:function(a,b,c){var d=e(a,b);c=q(c);var g=
c[0];c=c[1];switch(g){case 0:this.o(a,b);this.fire("create_request",a,b,c);break;case 1:this.c.has(d)&&(d=this.c.get(d),d.J?(a=d.J,this.D(a.T,a.U,c)):this.fire("create_response",a,b,c))}},P:function(a,b,c){var d=this;this.S(a,b,c).then(function(c){var g=e(a,b);!d.f.has(g)&&d.a.has(g)?d.B(g,c):d.L(a,b,c).then(function(c){var e=q(c.plaintext);var f=e[0];e=e[1];switch(f){case 2:try{var h=e.subarray(0,d.w);var r=e.subarray(d.w);var k=d.V(h,r);var v={T:a,U:b};var l=[h,k];d.o(a,b,{I:l});d.o(h,k,{J:v})}catch(x){c=
x;if(!(c instanceof RangeError))throw c;d.D(a,b,new Uint8Array(0))}break;case 3:d.l.has(g)&&d.fire("extend_response",a,b,e);break;default:10>f||d.fire("data",a,b,c.target_address,f-10,e)}},function(){if(d.a.has(g))d.B(g,c);else if(d.c.has(g)){var e=d.c.get(g);if(e.I){var f=e.I;e=f[0];f=f[1];d.g(a,b);d.g(e,f);d.K(a,b,e,f)&&d.B(g,c)}}})})["catch"](p)},B:function(a,b){var c=this.a.get(a);a=c[0];c=c[1];b=h(this.i,this.s,c,b);this.h(a,c,b)},N:function(a){var b;var c=0;for(b=Math.pow(2,16);c<b;++c){var d=
c;d=n(d);var g=e(a,d);if(!this.b.has(g)&&!this.c.has(g)&&!this.f.has(g))return d}throw new RangeError("Out of possible segment IDs");},F:function(a,b,c){b=l(b,c,this.m());return h(this.i,this.s,a,b)},u:function(a,b,c,d,e){var g=this;d=l(d,e,this.m());return this.M(a,b,c,d).then(function(a){return h(g.i,g.s,b,a)})},K:function(a,b,c,d){var g=e(a,b);var f=e(c,d);if(this.a.has(g)||this.a.has(f))return!1;this.a.set(g,[c,d]);this.a.set(f,[a,b]);return!0},C:function(a,b){a=e(a,b);if(this.a.has(a)){var c=
this.a.get(a);b=c[0];c=c[1];b=e(b,c);this.a["delete"](a);this.a["delete"](b)}},o:function(a,b,c){!c&&(c={});this.g(a,b);var d=e(a,b);var g=a.join("");this.c.set(d,c);this.j.has(g)||this.j.set(g,[]);c=this.j.get(g);c.push(b);c.length>this.O&&(b=c.shift(),this.g(a,b))},g:function(a,b){var c;var d=e(a,b);if(this.c.has(d)){this.c["delete"](d);a=a.join("");b=b.join("");d=this.j.get(a);var g=0;for(c=d.length;g<c;++g){var f=g;var h=d[g];if(h.join("")===b){d.splice(f,1);return}}if(!d.length)this.j["delete"](a)}},
M:function(a,b,c,d){var g,f=this;var h=e(a,b);var k={address:a,segment_id:b,target_address:c,plaintext:d,ciphertext:null};var l=this.fire("encrypt",k).then(function(){var a=k.ciphertext;if(!(a instanceof Uint8Array)||a.length!==d.length+f.v)throw"Encryption failed";return a});this.b.has(h)?g=this.b.get(h):g=[c];g=function(a){var b,c;var d=[];var e=0;for(c=(b=g).length;e<c;++e){var f=b[e];d.push(f);if(a===f.join(","))break}return d}.call(this,c.join(","));g.reverse().forEach(function(c){return l=l.then(function(d){return f.H(a,
b,c,d)})});l["catch"](function(){});return l},L:function(a,b,c){var d,f=this;var h=e(a,b);this.b.has(h)?d=this.b.get(h):d=[a];var k=Promise.reject();var l={address:a,segment_id:b,target_address:null,ciphertext:c,plaintext:null};d.forEach(function(d,e){k=k["catch"](function(){l.target_address=d;return 0<e?f.G(a,b,d,l.ciphertext).then(function(a){l.ciphertext=a;return f.fire("decrypt",l)}):f.fire("decrypt",l)}).then(function(){var a=l.plaintext;if(!(a instanceof Uint8Array)||a.length!==c.length-f.v)throw"Decryption failed";
return l})});return k},S:function(a,b,c){var d=e(a,b);if(this.b.has(d)||this.f.has(d))return this.G(a,b,a,c);a=this.a.get(d);b=a[0];return this.H(b,a[1],b,c)},H:function(a,b,c,d){var e={address:a,segment_id:b,target_address:c,unwrapped:d,wrapped:null};return this.fire("wrap",e).then(function(){var a=e.wrapped;if(!(a instanceof Uint8Array)||a.length!==d.length)throw"Wrapping failed";return a})},G:function(a,b,c,d){var e={address:a,segment_id:b,target_address:c,wrapped:d,unwrapped:null};return this.fire("unwrap",
e).then(function(){var a=e.unwrapped;if(!(a instanceof Uint8Array)||a.length!==d.length)throw"Unwrapping failed";return a})}};k.prototype=Object.assign(Object.create(u.prototype),k.prototype);Object.defineProperty(k.prototype,"constructor",{enumerable:!1,value:k})}).call(this)},{"async-eventer":1}]},{},[2])(2)});